---
title: "Centralville Walksheds"
author: "Raveena John"
date: "2/14/2022"
output: html_document
---


```{r}
options(java.parameters = "-Xmx3G")

library(r5r)
library(osmextract)
library(tidyverse)
library(sf)
library(ggthemes)
library(ggspatial)
library(tigris)
library(wesanderson)
library(tidytransit)
```

```{r}
dir.create("networks")

download.file("https://data.trilliumtransit.com/gtfs/lowell-ma-us/lowell-ma-us.zip", file.path("networks","Lowellgtfs.zip"), mode = "wb", quiet=TRUE)
```


```{r}
Low_streets <- oe_read("networks/Lowell.osm.pbf",
                       download_directory = "networks",
                       layer = "lines",
                       quiet = TRUE)

Low_streets<- Low_streets %>%
  filter(!is.na(highway)) 

Low_points <- oe_read("networks/Lowell.osm.pbf",
                      download_directory = "networks",
                      layer = "points",
                      quiet = TRUE)

Low_stops <- Low_points %>%
  filter(str_detect(other_tags, '"public_transport"=>"stop_position"'))

ggplot()+
  geom_sf(data = Low_streets, alpha = 0.1)+
  geom_sf(data = Low_stops, color = "orange") +
  theme_void()
```

```{r load data}
MA_state_plane <- "+proj=lcc +lat_1=41.71666666666667 +lat_2=42.68333333333333 +lat_0=41 +lon_0=-71.5 +x_0=200000 +y_0=750000 +ellps=GRS80 +units=m +no_defs"

Parks <- st_read("openspace_gdb/OpenSpace.gdb")
#Boundaries <- st_read("townssurvey_gdb/townssurvey.gdb")
#Low_boundary <- Boundaries %>%
#  filter(TOWN == "LOWELL")

Low_city_limits <- places("Massachusetts")%>%
  filter(NAME == "Lowell")# %>%
#  st_transform(crs = st_crs(Low_streets))

Low_parks <- Parks%>%
  filter(TOWN_ID == 160)

ggplot(Low_streets)+
  geom_sf(color = 'gray')+
  geom_sf(data = Low_parks, fill = "darkgreen")+
  theme_void()
```

```{r park centroid}
park_centroid <- st_centroid(Low_parks)
park_centroid <- park_centroid%>%
  mutate(id=seq(1,length(park_centroid$SHAPE),by=1))

ggplot(park_centroid)+
  geom_sf()
```

```{r set up grid}
grid <- st_sf(st_make_grid(Low_city_limits, 
                           square = FALSE, 
                           n = c(100,100),
                           what = "polygons")) %>%
  st_filter(Low_city_limits) 

colnames(grid) <- "geometry"
st_geometry(grid) <- "geometry"

grid <- grid %>%
  mutate(id = seq(1, length(grid$geometry), by=1))

grid_points <- st_centroid(grid)

ggplot(grid) +
  geom_sf() +
  geom_sf(data = Low_parks, fill = "darkgreen") +
  geom_sf(data = Low_streets, alpha = 0.2) + 
  theme_map()
```

```{r}
r5r_core <- setup_r5("networks", verbose = FALSE)
```

```{r}
ttm <- travel_time_matrix(r5r_core = r5r_core,
                          origins = park_centroid,
                          destinations = grid_points,
                          mode = c("WALK"),
                          departure_datetime = as.POSIXct("15-11-2021 14:00:00",
                                 format = "%d-%m-%Y %H:%M:%S"),
                          max_trip_duration = 480,
                          verbose = FALSE)
```

```{r}
tt_wide <- ttm %>%
  pivot_wider(names_from = fromId, 
              names_prefix = "from", values_from = travel_time) %>%
  rename(id = toId) %>% 
  merge(grid) %>%
  replace(is.na(.), 999) %>%
  rowwise() %>%
  mutate(from_any = min(c_across(starts_with("from")), na.rm = TRUE))

st_geometry(tt_wide) <- "geometry"
```



